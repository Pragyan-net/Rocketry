<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Rocket Launch Simulator</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />

  <link href="https://cdn.jsdelivr.net/npm/tailwindcss@2.2.19/dist/tailwind.min.css" rel="stylesheet" />

  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/file-saver@2.0.5/dist/FileSaver.min.js"></script>
</head>
<body class="bg-gray-900 text-white font-sans">

  <main class="p-6 max-w-5xl mx-auto">
    <h1 class="text-3xl font-bold mb-6 text-blue-400">Rocket Launch Simulator</h1>

    <div class="grid grid-cols-1 md:grid-cols-2 gap-4 bg-gray-800 p-6 rounded">
      <label>Mass (kg)
        <input type="number" id="mass" step="any" class="p-2 rounded w-full text-black">
      </label>
      <label>Fuel Mass (kg)
        <input type="number" id="fuel" step="any" class="p-2 rounded w-full text-black">
      </label>
      <label>ISP (s)
        <input type="number" id="isp" step="any" class="p-2 rounded w-full text-black">
      </label>
      <label>Thrust (N)
        <input type="number" id="thrust" step="any" class="p-2 rounded w-full text-black">
      </label>
      <label>Drag Coefficient
        <input type="number" id="cd" step="any" class="p-2 rounded w-full text-black">
      </label>
      <label>Cross-sectional Area (m²)
        <input type="number" id="area" step="any" class="p-2 rounded w-full text-black">
      </label>
      <label>Launch Angle (°)
        <input type="number" id="angle" step="any" class="p-2 rounded w-full text-black">
      </label>
      <label>Stages
        <input type="number" id="stages" step="1" class="p-2 rounded w-full text-black">
      </label>
    </div>

    <div class="mt-6 flex gap-4 flex-wrap">
      <button id="simulateBtn" class="bg-blue-600 hover:bg-blue-800 px-4 py-2 rounded">Simulate Launch</button>
      <button id="saveConfigBtn" class="bg-yellow-600 hover:bg-yellow-800 px-4 py-2 rounded">Save Configuration</button>
      <button id="exportCsvBtn" class="bg-green-600 hover:bg-green-800 px-4 py-2 rounded">Export CSV</button>
      <button id="exportPdfBtn" class="bg-purple-600 hover:bg-purple-800 px-4 py-2 rounded">Download PDF</button>
    </div>

    <div class="mt-8 bg-gray-800 p-6 rounded grid grid-cols-1 md:grid-cols-2 gap-6">
      <div class="bg-white p-2 rounded">
        <canvas id="altitudeChart" height="200"></canvas>
      </div>
      <div class="bg-white p-2 rounded">
        <canvas id="velocityChart" height="200"></canvas>
      </div>
      <div class="bg-white p-2 rounded">
        <canvas id="accelerationChart" height="200"></canvas>
      </div>
    </div>
  </main>

  <script>
    const g0 = 9.81;
    let altitudeChart, velocityChart, accelerationChart;

    document.getElementById("simulateBtn").addEventListener("click", () => {
      const mass = parseFloat(document.getElementById("mass").value);
      const fuel = parseFloat(document.getElementById("fuel").value);
      const isp = parseFloat(document.getElementById("isp").value);
      const thrust = parseFloat(document.getElementById("thrust").value);
      const cd = parseFloat(document.getElementById("cd").value);
      const area = parseFloat(document.getElementById("area").value);
      const angle = parseFloat(document.getElementById("angle").value);
      const stages = parseInt(document.getElementById("stages").value);

      const initialMass = mass + fuel;
      const burnTime = (fuel * isp * g0) / thrust;

      // Basic simulation
      const telemetry = [];
      let time = 0, dt = 0.5;
      let velocity = 0, altitude = 0, acceleration = 0;
      let currentMass = initialMass;

      // Store previous acceleration for calculating current acceleration in the loop
      let prevAcceleration = 0;

      while (currentMass > mass) {
        // Calculate drag force
        const dragForce = 0.5 * 1.225 * velocity ** 2 * cd * area;
        // Calculate net force
        const netForce = thrust - dragForce - currentMass * g0;
        // Calculate acceleration
        acceleration = netForce / currentMass;
        velocity += acceleration * dt;
        altitude += velocity * dt;
        currentMass -= (fuel / burnTime) * dt;
        time += dt;
        telemetry.push({ time, velocity, altitude, acceleration });

        // A very simple approximation for max Q (maximum dynamic pressure).
        // For a more accurate Max Q, you'd need to track dynamic pressure (0.5 * rho * v^2)
        // and find its peak. Here we'll just log it for demonstration if you wanted to expand.
        // const dynamicPressure = 0.5 * 1.225 * velocity ** 2; // For constant density, simplify.
      }

      drawCharts(telemetry);
      window.latestTelemetry = telemetry; // for export
    });

    function drawCharts(data) {
      const labels = data.map(d => d.time.toFixed(1));
      const altitudes = data.map(d => d.altitude.toFixed(2));
      const velocities = data.map(d => d.velocity.toFixed(2));
      const accelerations = data.map(d => d.acceleration.toFixed(2));

      // Altitude Chart
      const altitudeCtx = document.getElementById('altitudeChart').getContext('2d');
      if (altitudeChart) altitudeChart.destroy();
      altitudeChart = new Chart(altitudeCtx, {
        type: 'line',
        data: {
          labels,
          datasets: [{
            label: 'Altitude (m)',
            data: altitudes,
            backgroundColor: 'rgba(59, 130, 246, 0.2)',
            borderColor: 'rgba(59, 130, 246, 1)',
            borderWidth: 2,
            fill: true
          }]
        },
        options: {
          responsive: true,
          plugins: {
            legend: { labels: { color: 'black' } },
            title: {
              display: true,
              text: 'Altitude vs. Time',
              color: 'black'
            }
          },
          scales: {
            x: { title: { display: true, text: 'Time (s)', color: 'black' }, ticks: { color: 'black' } },
            y: { title: { display: true, text: 'Altitude (m)', color: 'black' }, ticks: { color: 'black' }, beginAtZero: true }
          }
        }
      });

      // Velocity Chart
      const velocityCtx = document.getElementById('velocityChart').getContext('2d');
      if (velocityChart) velocityChart.destroy();
      velocityChart = new Chart(velocityCtx, {
        type: 'line',
        data: {
          labels,
          datasets: [{
            label: 'Velocity (m/s)',
            data: velocities,
            backgroundColor: 'rgba(34, 197, 94, 0.2)',
            borderColor: 'rgba(34, 197, 94, 1)',
            borderWidth: 2,
            fill: true
          }]
        },
        options: {
          responsive: true,
          plugins: {
            legend: { labels: { color: 'black' } },
            title: {
              display: true,
              text: 'Velocity vs. Time',
              color: 'black'
            }
          },
          scales: {
            x: { title: { display: true, text: 'Time (s)', color: 'black' }, ticks: { color: 'black' } },
            y: { title: { display: true, text: 'Velocity (m/s)', color: 'black' }, ticks: { color: 'black' }, beginAtZero: true }
          }
        }
      });

      // Acceleration Chart
      const accelerationCtx = document.getElementById('accelerationChart').getContext('2d');
      if (accelerationChart) accelerationChart.destroy();
      accelerationChart = new Chart(accelerationCtx, {
        type: 'line',
        data: {
          labels,
          datasets: [{
            label: 'Acceleration (m/s²)',
            data: accelerations,
            backgroundColor: 'rgba(234, 179, 8, 0.2)',
            borderColor: 'rgba(234, 179, 8, 1)',
            borderWidth: 2,
            fill: true
          }]
        },
        options: {
          responsive: true,
          plugins: {
            legend: { labels: { color: 'black' } },
            title: {
              display: true,
              text: 'Acceleration vs. Time',
              color: 'black'
            }
          },
          scales: {
            x: { title: { display: true, text: 'Time (s)', color: 'black' }, ticks: { color: 'black' } },
            y: { title: { display: true, text: 'Acceleration (m/s²)', color: 'black' }, ticks: { color: 'black' } }
          }
        }
      });
    }

    document.getElementById("exportCsvBtn").addEventListener("click", () => {
      const data = window.latestTelemetry || [];
      if (data.length === 0) return alert("Run simulation first.");
      const rows = data.map(d => `${d.time},${d.velocity},${d.altitude},${d.acceleration}`);
      const csv = "Time (s),Velocity (m/s),Altitude (m),Acceleration (m/s²)\n" + rows.join("\n");
      const blob = new Blob([csv], { type: 'text/csv;charset=utf-8;' });
      saveAs(blob, "telemetry.csv");
    });

    document.getElementById("exportPdfBtn").addEventListener("click", () => {
      const doc = new jspdf.jsPDF();
      const data = window.latestTelemetry || [];
      doc.text("Rocket Telemetry Report", 10, 10);
      data.slice(0, 30).forEach((d, i) => {
        doc.text(`${d.time}s | V: ${d.velocity.toFixed(2)} m/s | Alt: ${d.altitude.toFixed(2)} m | Acc: ${d.acceleration.toFixed(2)} m/s²`, 10, 20 + i * 6);
      });
      doc.save("report.pdf");
    });

    document.getElementById("saveConfigBtn").addEventListener("click", () => {
      const config = {
        mass: document.getElementById("mass").value,
        fuel: document.getElementById("fuel").value,
        isp: document.getElementById("isp").value,
        thrust: document.getElementById("thrust").value,
        cd: document.getElementById("cd").value,
        area: document.getElementById("area").value,
        angle: document.getElementById("angle").value,
        stages: document.getElementById("stages").value,
        timestamp: new Date().toISOString()
      };
      localStorage.setItem(`config-${Date.now()}`, JSON.stringify(config));
      alert("Rocket configuration saved!");
    });
  </script>
</body>
</html>
